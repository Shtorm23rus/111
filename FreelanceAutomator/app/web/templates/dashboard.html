{% extends "base.html" %}

{% block title %}Dashboard - Freelance AI Assistant{% endblock %}

{% block extra_css %}
<style>
    .controls {
        margin-bottom: 30px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .jobs-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .jobs-table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }
    
    .jobs-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .jobs-table tr:hover {
        background: #f8f9fa;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
    }
    
    .status-pending { background: #fff3cd; color: #856404; }
    .status-in_progress { background: #cce5ff; color: #004085; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-failed { background: #f8d7da; color: #721c24; }
    
    .complexity-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 8px;
        font-size: 0.8em;
    }
    
    .complexity-1 { background: #d4edda; color: #155724; }
    .complexity-2 { background: #fff3cd; color: #856404; }
    .complexity-3 { background: #f8d7da; color: #721c24; }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .btn-small {
        padding: 6px 12px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div id="stats" class="stats-grid">
    <div class="stat-card">
        <h3 id="stat-total">0</h3>
        <p>–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</p>
    </div>
    <div class="stat-card">
        <h3 id="stat-pending">0</h3>
        <p>–í –æ—á–µ—Ä–µ–¥–∏</p>
    </div>
    <div class="stat-card">
        <h3 id="stat-completed">0</h3>
        <p>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
    </div>
    <div class="stat-card">
        <h3 id="stat-failed">0</h3>
        <p>–û—à–∏–±–æ–∫</p>
    </div>
</div>

<div class="controls">
    <button class="btn" onclick="scrapeJobs()">üîç –°–æ–±—Ä–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è</button>
    <button class="btn" onclick="loadJobs()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
    <select id="statusFilter" class="btn" onchange="loadJobs()">
        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
        <option value="pending">–í –æ—á–µ—Ä–µ–¥–∏</option>
        <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
        <option value="failed">–û—à–∏–±–∫–∏</option>
    </select>
</div>

<div id="jobs-container">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadStats() {
    try {
        const response = await fetch('/api/stats');
        const stats = await response.json();
        
        document.getElementById('stat-total').textContent = stats.total_jobs;
        document.getElementById('stat-pending').textContent = stats.pending;
        document.getElementById('stat-completed').textContent = stats.completed;
        document.getElementById('stat-failed').textContent = stats.failed;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadJobs() {
    const container = document.getElementById('jobs-container');
    container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    try {
        const status = document.getElementById('statusFilter').value;
        const url = status ? `/api/jobs?status=${status}` : '/api/jobs';
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.jobs.length === 0) {
            container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</p>';
            return;
        }
        
        let html = '<table class="jobs-table"><thead><tr>';
        html += '<th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ë—é–¥–∂–µ—Ç</th>';
        html += '<th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>';
        html += '</tr></thead><tbody>';
        
        data.jobs.forEach(job => {
            html += `<tr>
                <td>${job.job_id.substring(0, 8)}...</td>
                <td><strong>${job.title}</strong><br><small>${job.description}</small></td>
                <td>${job.category || 'N/A'}</td>
                <td>${job.budget ? '$' + job.budget : 'N/A'}</td>
                <td><span class="complexity-badge complexity-${job.complexity}">Level ${job.complexity}</span></td>
                <td><span class="status-badge status-${job.status}">${job.status}</span></td>
                <td>
                    ${job.status === 'pending' ? `<button class="btn btn-small" onclick="generateContent('${job.job_id}')">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>` : ''}
                    ${job.status === 'completed' ? `<button class="btn btn-small" onclick="viewContent('${job.job_id}')">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>` : ''}
                </td>
            </tr>`;
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading jobs:', error);
        container.innerHTML = '<p style="text-align: center; padding: 40px; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
    }
}

async function scrapeJobs() {
    if (!confirm('–ù–∞—á–∞—Ç—å —Å–±–æ—Ä –Ω–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π —Å Upwork?')) return;
    
    try {
        const response = await fetch('/api/scrape', { method: 'POST' });
        const result = await response.json();
        
        alert(`–ù–∞–π–¥–µ–Ω–æ: ${result.jobs_found} –∑–∞–¥–∞–Ω–∏–π\n–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${result.jobs_saved} –Ω–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π`);
        loadJobs();
        loadStats();
    } catch (error) {
        console.error('Error scraping:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –∑–∞–¥–∞–Ω–∏–π');
    }
}

async function generateContent(jobId) {
    if (!confirm('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è?')) return;
    
    try {
        const response = await fetch(`/api/generate/${jobId}`, { method: 'POST' });
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('–ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!');
            loadJobs();
            loadStats();
        } else {
            alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞');
        }
    } catch (error) {
        console.error('Error generating:', error);
        alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞');
    }
}

async function viewContent(jobId) {
    try {
        const response = await fetch(`/api/jobs/${jobId}/content`);
        const data = await response.json();
        
        if (data.content.length === 0) {
            alert('–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const content = data.content[0];
        alert(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç:\n\n${content.generated_text}`);
    } catch (error) {
        console.error('Error viewing content:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞');
    }
}

loadJobs();
loadStats();
setInterval(() => { loadStats(); }, 30000);
</script>
{% endblock %}
